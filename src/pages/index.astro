---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { Image } from "astro:assets";
import Box from "../assets/box.png"; // 削除ボタン
import Plus from "../assets/plus.png"; // 追加ボタン

import "../styles/style.scss";
---

<style lang="scss">
.main-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #FBEFE0;
}

.input-form {
  position: sticky;
  top: 0;
  background: #FBEFE0;
  padding: 10px 20px;
  display: flex;
  justify-content: center;
  gap: 10px;
  z-index: 10;

  input {
    padding: 10px;
    font-size: 16px;
    width: 60%;
    background: #eee;
    border: none;
    border-radius: 4px;
  }

  button {
    background: #AE9890;
    color: white;
    border: none;
    padding: 10px 20px;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
  }
}

.todo-list {
  flex-grow: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  padding: 10px 0;

  .todo-item {
    font-weight: bold;
    font-size: 18px;
    padding: 12px;
    border-bottom: 2px solid black;
    width: 80%;
    cursor: pointer;
    transition: background 0.3s;
  }

  .todo-item.selected {
    background: #f9bcbc;
  }
}

.btn-area {
  margin: 30px 0;
  display: flex;
  justify-content: center;
  gap: 40px;

  img {
    width: 60px;
    height: 60px;
    background: #AE9890;
    border-radius: 50%;
    padding: 10px;
    cursor: pointer;
  }
}
</style>

<Layout>
  <Header />
  <main class="main-container">
    <!-- 入力欄 -->
    <div class="input-form">
      <input type="text" id="todo-input" placeholder="やることを書く" />
      <button id="add-todo">追加</button>
    </div>

    <!-- ToDoリスト -->
    <div id="todo-list" class="todo-list"></div>

    <!-- ボタンたち -->
    <div class="btn-area">
      <Image src={Box} alt="削除" id="delete-button" />
      <Image src={Plus} alt="追加" id="add-button" />
    </div>
  </main>
  <Footer />

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("todo-input");
      const addBtn = document.getElementById("add-todo");
      const plusBtn = document.getElementById("add-button");
      const deleteBtn = document.getElementById("delete-button");
      const list = document.getElementById("todo-list");

      let todos = JSON.parse(localStorage.getItem("todos") || "[]");

      // 初期表示
      todos.forEach(text => createTodoItem(text));

      // ToDo追加処理
      function addTodo(text) {
        todos.unshift(text);
        saveTodos();
        createTodoItem(text, true);
      }

      // ToDo要素作成
      function createTodoItem(text, prepend = false) {
        const todo = document.createElement("div");
        todo.className = "todo-item";
        todo.textContent = text;

        // 完了確認
        todo.addEventListener("click", () => {
          const ok = confirm("完了しましたか？");
          if (ok) {
            todo.classList.toggle("selected");
          }
        });

        prepend ? list.prepend(todo) : list.appendChild(todo);
      }

      // 入力欄 → ボタン
      addBtn.addEventListener("click", () => {
        const text = input.value.trim();
        if (!text) return;
        addTodo(text);
        input.value = "";
      });

      // プラス画像 → フォーカス
      plusBtn.addEventListener("click", () => {
        input.focus();
      });

      // ✅ 削除ボタン処理
      deleteBtn.addEventListener("click", () => {
        const selected = [...document.querySelectorAll(".todo-item.selected")];
        if (selected.length === 0) {
          alert("削除する項目を選択してください");
          return;
        }

        // DOM削除 & 配列更新
        selected.forEach(item => {
          const text = item.textContent;
          todos = todos.filter(t => t !== text);
          item.remove();
        });

        saveTodos();
      });

      function saveTodos() {
        localStorage.setItem("todos", JSON.stringify(todos));
      }
    });
  </script>
</Layout>
